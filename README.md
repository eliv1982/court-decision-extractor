# Извлечение данных из судебных решений

Python-инструмент для извлечения структурированных данных из судебных решений (скан-образы, PDF) с использованием мультимодальной модели OpenAI GPT-4o. **Анализирует весь документ** (все страницы PDF или одно изображение), объединяет результаты и выдаёт один JSON: краткое резюме, ключевые выводы и структурированные поля без выгрузки полного текста.

## Возможности

- **Входные форматы:** изображения (`.jpg`, `.jpeg`, `.png`) и PDF
- **Анализ всего документа:** для PDF по умолчанию обрабатываются **все страницы**; каждая страница анализируется отдельно, результаты объединяются в один итоговый JSON (тип документа, суд, номер дела, стороны, резолютивная часть, правовые основания, объединённые резюме и выводы и т.д.)
- **Режим одной страницы:** флаг `--first-page-only` — обрабатывается только первая страница PDF (для экономии токенов)
- **Выход:** единый JSON с полями: тип документа, суд, номер дела, дата, судья, стороны, сумма иска, резолютивная часть, правовые основания, резюме, ключевые выводы, персоны, даты, суммы, таблицы

## Установка

### 1. Виртуальное окружение и зависимости

```bash
python -m venv venv
# Windows (PowerShell). Если путь содержит пробелы — в кавычках:
.\venv\Scripts\Activate.ps1
# Windows (cmd):
venv\Scripts\activate.bat
# Linux/macOS:
# source venv/bin/activate

pip install -r requirements.txt
```

### 2. Poppler (для работы с PDF)

Инструмент использует `pdf2image`, которому нужен **Poppler**. Без него при обработке PDF появится ошибка: *"Unable to get page count. Is poppler installed and in PATH?"*

#### Вариант А: Poppler в PATH (пошагово для Windows)

**Шаг 1. Скачать Poppler**

1. Откройте в браузере: https://github.com/oschwartz10612/poppler-windows/releases  
2. В разделе **Assets** найдите архив, например `Release-24.08.0-0.zip` (или последнюю версию).  
3. Нажмите на архив — он скачается в папку «Загрузки».

**Шаг 2. Распаковать архив**

1. Откройте папку «Загрузки», найдите скачанный ZIP.  
2. Щёлкните по архиву правой кнопкой → **«Извлечь всё»** (или «Распаковать»).  
3. Укажите папку для распаковки, например: `C:\Program Files\poppler`  
   - Если появится запрос прав администратора — разрешите.  
4. После распаковки внутри будет папка (например `Release-24.08.0-0`), а в ней — папка **`Library`**, внутри неё — **`bin`**.  
5. Запомните полный путь к папке **bin**, например:  
   `C:\Program Files\poppler\Release-24.08.0-0\Library\bin`

**Шаг 3. Добавить папку bin в PATH**

1. Нажмите **Win + R**, введите `sysdm.cpl`, нажмите Enter.  
2. Откроется окно «Свойства системы». Перейдите на вкладку **«Дополнительно»**.  
3. Внизу нажмите **«Переменные среды»**.  
4. В блоке **«Переменные среды пользователя»** (верхняя таблица) найдите переменную **`Path`**, выделите её и нажмите **«Изменить»**.  
5. В окне «Изменение переменной среды» нажмите **«Создать»**.  
6. В новой строке вставьте путь к папке **bin** (из шага 2), например:  
   `C:\Program Files\poppler\Release-24.08.0-0\Library\bin`  
7. Нажмите **«ОК»** во всех открытых окнах.  
8. **Обязательно закройте все окна терминала и Cursor** и откройте их заново — PATH обновится только в новых сеансах.

**Шаг 4. Проверить**

1. Откройте **новый** терминал (обязательно после добавления PATH закройте и откройте Cursor/терминал заново).  
2. Выполните:
   ```powershell
   pdfinfo -v
   ```
   Если Poppler в PATH, появится строка с версией (например `pdfinfo version 24.08.0`).  
3. **Если команда не найдена:** проверьте путь по полному имени. Подставьте свой путь к папке `bin`:
   ```powershell
   & "C:\Program Files\poppler\Release-24.08.0-0\Library\bin\pdfinfo.exe" -v
   ```
   Если версия выводится — Poppler установлен, в PATH добавлена не та папка (должна быть именно папка `bin`). Добавьте в PATH путь к `bin` ещё раз (шаг 3) и перезапустите терминал.  
   **Либо** используйте Вариант Б: в `.env` укажите `POPPLER_PATH=путь к папке bin` — тогда PATH не нужен.

После этого снова запускайте `python main.py "путь к файлу.pdf"` — ошибка конвертации PDF должна исчезнуть.

---

**Вариант Б (без PATH):** положите распакованный Poppler в папку проекта и укажите в `.env` строку:
```env
POPPLER_PATH=C:\Users\eshle\Cursor projects\Multimodal\Обработка файлов\poppler\Release-24.08.0-0\Library\bin
```
(подставьте свой путь к папке `bin`.)

**macOS:** `brew install poppler`  

**Linux (Debian/Ubuntu):** `sudo apt install poppler-utils`

### 3. Ключ API OpenAI

Создайте файл `.env` в корне проекта (можно скопировать из примера):

```bash
copy .env.example .env
```

Откройте `.env` и укажите свой ключ:

```
OPENAI_API_KEY=sk-...
```

Ключ можно также задать переменной окружения `OPENAI_API_KEY` (файл `.env` тогда не обязателен).

## Использование

```bash
python main.py <path_to_file> [--output OUTPUT] [--model MODEL] [--first-page-only] [--pretty]
```

| Аргумент | Описание |
|----------|----------|
| `path_to_file` | Обязательный. Путь к PDF или изображению |
| `--output`, `-o` | Файл для сохранения JSON (по умолчанию вывод в stdout) |
| `--model` | Модель OpenAI (по умолчанию: `gpt-4o`) |
| `--first-page-only` | Обрабатывать только первую страницу PDF (для экономии токенов) |
| `--pretty` | Форматировать JSON с отступами |

### Как обрабатывается многостраничный PDF

1. PDF конвертируется в изображения (по одной на страницу) через `pdf2image`.
2. Каждая страница отправляется в GPT-4o; модель возвращает частичный JSON по этой странице.
3. Функция `merge_results` объединяет частичные результаты: уникальные поля (суд, номер дела, стороны и т.д.) берутся по первому непустому значению; списки (персоны, даты, суммы, таблицы, ключевые выводы, правовые основания) склеиваются; итоговое резюме — самое длинное из резюме по страницам (или первое непустое).
4. Постобработка `postprocess`: дедупликация `people` и `legal_basis`, валидация чисел и дат, приведение `key_findings` к формату `{finding, evidence}`.

В результате вы получаете **один JSON на весь документ**.

### Примеры

```bash
# Весь документ (все страницы PDF), результат в консоль
python main.py решение.pdf

# Путь с пробелами (Windows) — в кавычках
python main.py "C:\Users\Имя\Мои документы\решение.pdf"

# Файл в «Загрузках» (на русской Windows папка часто называется «Загрузки»)
python main.py "C:\Users\eshle\Загрузки\A40-260440-2021_20230529_Opredelenie.pdf" -o result.json --pretty
# Точный путь: в проводнике ПКМ по файлу → «Копировать как путь», вставьте в кавычках

# Результат в файл, красивый JSON
python main.py решение.pdf --output result.json --pretty

# Только первая страница PDF (экономия токенов)
python main.py решение.pdf --first-page-only

# Один скан/фото страницы
python main.py scan_1.jpg -o out.json --pretty
```

## Структура ответа (JSON)

- `document_type`, `court_name`, `case_number`, `date`, `judge`, `plaintiff`, `defendant`, `third_party`
- `claim_amount`: `{ "value": число, "currency": "руб." }`
- `claim_subject`, `ruling`
- `legal_basis`: массив строк в формате «ст. N ГК РФ» / «ст. N АПК РФ» (без дублей)
- `summary` — краткое резюме (всегда присутствует)
- `key_findings`: массив `[{ "finding": "текст вывода", "evidence": "цитата из решения" }]` (всегда присутствует)
- `people`: `[{ "full_name": "ФИО в И.п.", "role": "истец|ответчик|судья|..." }]` (дедупликация по ФИО+роль)
- `dates`: `[{ "label": "...", "value": "..." }]`
- `amounts`: `[{ "label": "...", "value": число, "currency": "..." }]`
- `tables`: `[{ "name": "...", "columns": [], "rows": [] }]`

Поля, которые не удалось извлечь, могут отсутствовать или быть `null`; `summary` и `key_findings` возвращаются всегда.

## Обработка ошибок

- **Файл не найден** — проверьте путь к файлу
- **Нет OPENAI_API_KEY** — задайте ключ в `.env` или в переменной окружения
- **Ошибка конвертации PDF** — установите Poppler и добавьте его в `PATH`
- **Неподдерживаемый формат** — используйте `.jpg`, `.jpeg`, `.png` или `.pdf`
- **Windows: путь не распознаётся** — если в пути есть пробелы, заключите путь в кавычки: `python main.py "путь к файлу.pdf"`

## Структура проекта (репозиторий на GitHub)

В репозиторий выгружаются только эти файлы:

```
.
├── .gitignore        # игнорирование venv, .env, __pycache__ и т.д.
├── .env.example      # шаблон переменных окружения (скопировать в .env)
├── main.py           # основной скрипт
├── requirements.txt  # зависимости Python
└── README.md         # инструкция
```

Локально после клонирования нужно создать виртуальное окружение (`venv/`) и файл `.env` с ключом API — они в `.gitignore` и в репозиторий не попадают.

## Конфиденциальность

Ключ API загружается из переменной окружения `OPENAI_API_KEY` (в том числе через `.env` при использовании `python-dotenv`). Не публикуйте файл `.env` и не добавляйте его в репозиторий.
